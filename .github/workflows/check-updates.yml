name: Check and Update Godot Preview

on:
  schedule:
    # Run every 2 days at 00:00 UTC
    - cron: '0 0 */2 * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version unchanged'
        required: false
        default: false
        type: boolean

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for latest Godot preview version
      id: check
      run: |
        set -euo pipefail

        # Apply sorting weights: dev=1, beta=2, rc=3

        LATEST_RELEASE=$(
          curl -fsSL "https://api.github.com/repos/godotengine/godot-builds/releases?per_page=100" | \
          jq -r '.[] | select(.tag_name | test("^4\\..*-(dev|beta|rc)[0-9]+$")) | .tag_name' | \
          sed 's/-dev/.1dev/g; s/-beta/.2beta/g; s/-rc/.3rc/g' | \
          sort -V | \
          tail -n 1 | \
          sed 's/\.1dev/-dev/g; s/\.2beta/-beta/g; s/\.3rc/-rc/g'
        )

        if [[ -z "$LATEST_RELEASE" ]]; then
          echo "Error: Could not determine latest version."
          exit 1
        fi

        echo "Highest Semantic Version: $LATEST_RELEASE"
        echo "latest_version_raw=$LATEST_RELEASE" >> "$GITHUB_OUTPUT"

        # Convert for AUR (4.6-rc2 -> 4.6rc2)
        AUR_VERSION=$(echo "$LATEST_RELEASE" | tr -d '-')
        echo "latest_version=$AUR_VERSION" >> "$GITHUB_OUTPUT"

        # Check current AUR version via CGit (faster/simpler than cloning)
        CURRENT_VERSION=$(curl -fsSL "https://aur.archlinux.org/cgit/aur.git/plain/PKGBUILD?h=godot-preview-bin" 2>/dev/null | grep "^pkgver=" | cut -d= -f2 || echo "none")
        echo "Current AUR version: $CURRENT_VERSION"
        echo "current_version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"

        if [[ "$AUR_VERSION" != "$CURRENT_VERSION" ]] || [[ "${{ inputs.force_update }}" == "true" ]]; then
          echo "update_needed=true" >> "$GITHUB_OUTPUT"
        else
          echo "update_needed=false" >> "$GITHUB_OUTPUT"
        fi
    
    - name: Download and calculate checksum
      if: steps.check.outputs.update_needed == 'true'
      id: download
      run: |
        set -euo pipefail
        VERSION="${{ steps.check.outputs.latest_version_raw }}"
        URL="https://github.com/godotengine/godot-builds/releases/download/${VERSION}/Godot_v${VERSION}_linux.x86_64.zip"
        
        # Download and calculate checksum
        wget -O godot.zip "$URL"
        CHECKSUM=$(sha256sum godot.zip | cut -d ' ' -f 1)
        echo "sha256sum=$CHECKSUM" >> "$GITHUB_OUTPUT"
        
        # Get file size to verify download
        SIZE=$(stat -c%s godot.zip)
        echo "Download size: $SIZE bytes"
        rm godot.zip
    
    - name: Create PKGBUILD
      if: steps.check.outputs.update_needed == 'true'
      run: |
        set -euo pipefail
        mkdir -p aur-package
        cat > aur-package/PKGBUILD << 'EOF'
        # Maintainer: MLM-stuff gfxoxinzh@mozmail.com
        pkgname=godot-preview-bin
        pkgver=${{ steps.check.outputs.latest_version }}
        _realver=${{ steps.check.outputs.latest_version_raw }}
        pkgrel=1
        pkgdesc="Godot Engine Preview/Beta - Prebuilt binary from official builds"
        arch=('x86_64')
        url="https://godotengine.org"
        license=('MIT')
        depends=('glibc' 'libglvnd' 'libxcursor' 'libxi' 'libxinerama' 'libxrandr' 'hicolor-icon-theme' 'libxrender' 'libx11' 'libxext')
        optdepends=('pipewire-alsa: Audio support'
                    'pipewire-pulse: Audio support')
        provides=('godot-preview')
        conflicts=('godot-preview')
        source=("https://github.com/godotengine/godot-builds/releases/download/${_realver}/Godot_v${_realver}_linux.x86_64.zip"
                "godot-preview.desktop"
                "godot-preview.svg")
        sha256sums=('${{ steps.download.outputs.sha256sum }}'
                    'SKIP'
                    'SKIP')
        
        package() {
            # Extract binary
            install -dm755 "$pkgdir/opt/godot-preview"
            install -Dm755 "Godot_v${_realver}_linux.x86_64" "$pkgdir/opt/godot-preview/godot-preview"
            
            # Create symlink
            install -dm755 "$pkgdir/usr/bin"
            ln -s /opt/godot-preview/godot-preview "$pkgdir/usr/bin/godot-preview"
            
            # Install desktop entry
            install -Dm644 "$srcdir/godot-preview.desktop" "$pkgdir/usr/share/applications/godot-preview.desktop"
            
            # Install icon
            install -Dm644 "$srcdir/godot-preview.svg" "$pkgdir/usr/share/icons/hicolor/scalable/apps/godot-preview.svg"
        }
        EOF
        
        # Create desktop file
        cat > aur-package/godot-preview.desktop << 'EOF'
        [Desktop Entry]
        Name=Godot Preview
        Comment=Multi-platform 2D and 3D game engine (Preview/Beta)
        Exec=/usr/bin/godot-preview %f
        Icon=godot-preview
        Terminal=false
        Type=Application
        Categories=Development;Game;IDE;
        MimeType=application/x-godot-project;
        StartupWMClass=Godot
        EOF
        
        # Download Godot icon
        wget -O aur-package/godot-preview.svg "https://raw.githubusercontent.com/godotengine/godot/master/icon.svg"
    
    - name: Publish to AUR
      if: steps.check.outputs.update_needed == 'true'
      uses: mlm-games/aur-deploy-action@master
      with:
        pkgname: godot-preview-bin
        pkgbuild: aur-package/PKGBUILD
        assets: |
          aur-package/godot-preview.desktop
          aur-package/godot-preview.svg
        auto_pkgrel: 'true'
        commit_username: MLM-stuff
        commit_email: gfxoxinzh@mozmail.com
        ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
        commit_message: "Update to version ${{ steps.check.outputs.latest_version }}"
